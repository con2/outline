# Note: If you use Skaffold/Emskaffolden, leave these at defaults and let Skaffold manage the images
outline_image: outline-con2

# Set to false to manage a secret called "outline" yourself
outline_secret_managed: true

# Note: Cannot be autogenerated with current version of kubernetes-secret-generator, has to match output of `openssl rand -hex 32`
outline_secret_key: ''

# outline_tag: staging
# outline_repository: harbor.con2.fi/con2/outline
# outline_image: !Format "{outline_repository}:{outline_tag}"
# outline_static_image: !Format "{outline_repository}-static:{outline_tag}"

# Set this to the public hostname of your service.
ingress_public_hostname: outline.localhost

# If you use ingress-nginx and cert-manager, TLS can be automatically configured by setting this to true.
ingress_letsencrypt_enabled: false
ingress_letsencrypt_cluster_issuer: letsencrypt-prod

redis_managed: true
redis_image: redis
redis_hostname: redis
redis_database: 1
redis_storage_pvc: true
redis_storage_pvc_storageclass: !Void

# NOTE: "managed" PostgreSQL should not be considered production-ready.
postgres_managed: true
postgres_image: postgres
postgres_hostname: postgres
postgres_username: outline
postgres_database: outline
postgres_storage_pvc_storageclass: !Void

# Leave empty if you want to let kubernetes-secret-generator generate one for you
postgres_password: ''

# note: managed postgres doesn't provide ssl, only enable if using external postgres
postgres_ssl: false

# Whether or not "yarn sequelize:migrate" should run as init container
setup_should_run: true

kompassi_base_url: https://kompassi.eu
kompassi_team_name: Con2
kompassi_access_groups: []
kompassi_admin_groups: []

# TODO
aws_region: eu-west-1
aws_upload_bucket_url: https://nonexistent.example.com
aws_upload_bucket_name: nonexistent
aws_upload_max_size: 26214400
aws_s3_acl: private

smtp_hostname: ""
smtp_port: 25
smtp_from_email: ""
smtp_username: ""

# outline_secret_managed: false - ignored
# outline_secret_managed: true - set to this value in secret, or leave empty to have auto-generated via kubernetes-secret-generator
smtp_password: ""

# Configuration vars end here. Configuration snippets follow. May be overridden for advanced configuration.

# Security context for outline and Celery pods
outline_pod_security_context:
  runAsUser: 1000
  runAsGroup: 1000
outline_container_security_context:
  readOnlyRootFilesystem: true
  allowPrivilegeEscalation: false

# Common environment vars for both outline and celery pods.
outline_environment:
  - name: NODE_ENV
    value: production
  - name: PORT
    value: "3000"
  - name: SECRET_KEY
    valueFrom:
      secretKeyRef:
        name: outline
        key: secretKey
  - name: UTILS_SECRET_KEY
    valueFrom:
      secretKeyRef:
        name: outline
        key: utilsSecretKey
  - name: URL
    value: !Var ingress_url
  - name: REDIS_URL
    value: !Format "redis://{redis_hostname}/{redis_database}"
  - name: AWS_ACCESS_KEY_ID
    valueFrom:
      secretKeyRef:
        name: outline
        key: awsAccessKeyId
  - name: AWS_SECRET_ACCESS_KEY
    valueFrom:
      secretKeyRef:
        name: outline
        key: awsSecretAccessKey
  - name: AWS_REGION
    value: !Var aws_region
  - name: AWS_S3_UPLOAD_BUCKET_URL
    value: !Var aws_upload_bucket_url
  - name: AWS_S3_UPLOAD_BUCKET_NAME
    value: !Var aws_upload_bucket_name
  - name: AWS_S3_UPLOAD_MAX_SIZE
    value: !Format "{aws_upload_max_size}"
  - name: AWS_S3_ACL
    value: !Var aws_s3_acl
  - name: KOMPASSI_BASE_URL
    value: !Var kompassi_base_url
  - name: KOMPASSI_CLIENT_ID
    valueFrom:
      secretKeyRef:
        name: outline
        key: kompassiClientId
  - name: KOMPASSI_CLIENT_SECRET
    valueFrom:
      secretKeyRef:
        name: outline
        key: kompassiClientSecret
  - name: KOMPASSI_TEAM_NAME
    value: !Var kompassi_team_name
  - name: KOMPASSI_ACCESS_GROUPS
    value: !Join,Var kompassi_access_groups
  - name: KOMPASSI_ADMIN_GROUPS
    value: !Join,Var kompassi_admin_groups
  - name: POSTGRES_HOSTNAME
    valueFrom:
      secretKeyRef:
        name: postgres
        key: hostname
  - name: POSTGRES_DATABASE
    valueFrom:
      secretKeyRef:
        name: postgres
        key: database
  - name: POSTGRES_USERNAME
    valueFrom:
      secretKeyRef:
        name: postgres
        key: username
  - name: POSTGRES_PASSWORD
    valueFrom:
      secretKeyRef:
        name: postgres
        key: password
  - name: POSTGRES_PORT
    value: "5432"
  - name: POSTGRES_SSL
    value: !If
      test: !Var postgres_ssl
      then: "true"
      else: "false"
  - name: SMTP_HOST
    value: !Var smtp_hostname
  - name: SMTP_PORT
    value: !Format "{smtp_port}"
  - name: SMTP_FROM_EMAIL
    value: !Var smtp_from_email
  - !If
      test: !Var smtp_username
      then:
        name: SMTP_USERNAME
        valueFrom:
          secretKeyRef:
            name: outline
            key: smtpUsername
  - !If
      test: !Var smtp_username
      then:
        name: SMTP_PASSWORD
        valueFrom:
          secretKeyRef:
            name: outline
            key: smtpPassword

# Default annotations work for nginx ingress with or without LetsEncrypt TLS. Override if you need something else.
ingress_annotations: !If
  test: !Var ingress_letsencrypt_enabled
  then:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"

ingress_tls: !If
  test: !Var ingress_letsencrypt_enabled
  then:
    - secretName: ingress-letsencrypt
      hosts:
        - !Var ingress_public_hostname

ingress_url: !If
  test: !Var ingress_tls
  then: !Format "https://{ingress_public_hostname}"
  else: !Format "http://{ingress_public_hostname}"